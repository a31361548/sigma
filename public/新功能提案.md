# 新功能提案：加入無關節點並連線到右鍵選中節點

## 目標
使用者「右鍵選中某個節點」後，按下「加入節點」功能時：
1) 生成（或從預先準備的節點池取出）1 個或多個「原本無關的節點」
2) 立即新增連線（edge）把新節點連到該「右鍵選中節點」
3) 新節點與新邊在畫面上立即可見，並出現在合理位置（例如靠近被選中節點）

---

## 使用者流程（UI）
1) 使用者在圖上對某節點按右鍵
2) 顯示右鍵選單（現有）
3) 使用者點擊新增功能：`加入節點`（可做成右鍵選單項目或工具列按鈕）
4) 系統新增節點與連線，畫面即時更新

---

## 主要需求規格（需定案）

### A. 連線方向（Direction）
- 選項 1：`選中節點 -> 新節點`
- 選項 2：`新節點 -> 選中節點`
- 影響：
  - 箭頭方向與語意（例如「新增子節點」vs「新增來源節點」）
  - 若後續要做結構樹展開/收合，方向會影響操作直覺

### B. 連線類型（Edge Type）
- 選項 1：`structural`
  - 影響：通常會被「展開/隱藏」視為結構關係，也可能影響排版（例如 ELK 分層/群組）
  - 適用：你想把新節點當成選中節點的結構子節點
- 選項 2：`transactional`
  - 影響：更像一般關係線；通常不想干擾結構排版
  - 適用：你只想建立關聯，不想改動樹狀結構

### C. 新節點的「類型」與資料欄位
- 選項：`理專 / 客戶 / 投資組合 / 帳號 / 自訂（例如：無關節點）`
- 影響：
  - 顏色/大小（目前依 businessType 有不同顯示）
  - 右側資料詳情面板顯示欄位
  - 初始 hidden 規則（目前非理專多半會先 hidden，需要特別處理）

### D. 新節點是否立即可見
- 建議：新增後強制 `hidden=false`，避免被既有「初始只顯示理專」規則影響而看不到。

### E. 新節點位置策略（避免「新增了但找不到」）
- 建議方案：
  - 以選中節點座標為中心，半徑 r 做小圓/扇形放置
  - 多個節點則均分角度，避免重疊
  - 或直接放在滑鼠位置附近（需事件座標）

---

## 資料更新策略（兩種實作路線）

### 路線 A：只改 sigma/graphology 畫布內的 graph（即時、最小改動）
- 作法：直接在目前 sigma graph `addNode` / `addEdge` 後 `refresh`
- 優點：改動小、互動快、容易做
- 缺點：如果整張圖重新載入（切換資料源/重載 mock/json），新增內容可能消失（不在 App 的資料 state 內）

### 路線 B：寫回 App 的 nodes/edges state（更像「真的新增資料」）
- 作法：維護一份「使用者新增的增量 nodes/edges」，與原始資料 merge 後再丟給圖
- 優點：重新載入/刷新時仍可保留（取決於你是否清除增量）
- 缺點：需要多一層狀態管理與 merge 規則

---

## 與現有功能的互動影響（需注意）
- Hover 聚焦：目前關聯計算包含 structural + transactional；新增連線會影響 hover 關聯範圍（通常是預期行為）
- 展開/隱藏：若新增的是 structural 邊，會被「展開/隱藏」邏輯影響（預期內）
- ELK 排版：若你希望新增節點也被排版，需要定義它算不算在 ELK 的 structural 邊集合內
- Edge label：若新增邊需要顯示文字，要符合目前 edge label 顯示規則（hover/zoom 或特殊例外）

---

## 下次討論的最小決策清單（回答這些即可動工）
1) 連線方向：`選中->新` 或 `新->選中`
2) Edge 類型：`structural` 或 `transactional`
3) 新節點 businessType：要用哪一種（或自訂）
4) 一次加 1 個還是可選多個（預設 1）
5) 是否要「先建無關節點池」再取用，或按下就直接生成

