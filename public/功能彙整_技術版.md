# 功能彙整（技術版：含檔案位置）

> 這份是「技術版」：保留你剛剛那份含檔案位置/程式入口的整理，方便開發、維護與交接。  
> UI 使用者版本請看：`public/功能彙整.md`

---

## 0) 專案定位
- 目標：瀏覽器端關係圖探索器（Sigma.js v3 + graphology），支援展開/隱藏、搜尋定位、拖曳固定節點、群組排版（ELK）、右側資料面板、平行邊曲線顯示。
- 入口：`src/main.tsx:1`

### 0.1 技術棧（依賴側重）
- React + TypeScript + Vite：`src/main.tsx:1`、`vite.config.ts:1`、`tsconfig.app.json:1`
- Sigma v3（渲染/互動）+ graphology（圖資料結構）：`src/components/Graph/SigmaCanvas.tsx:1`
- ELK（排版）：`src/components/Graph/ElkLayout.tsx:1`
- 平行邊曲線：`@sigma/edge-curve`：`src/components/Graph/SigmaCanvas.tsx:17`
- 節點 icon：`@sigma/node-image`：`src/components/Graph/SigmaCanvas.tsx:12`
- 匯出圖片：`@sigma/export-image`：`src/components/Graph/SigmaCanvas.tsx:13`
- Web Worker：把 mock 生成與 json 解析移出主執行緒：`src/workers/graphData.worker.ts:1`

---

## 1) 專案結構與入口

### 1.1 啟動入口
- React 掛載：`src/main.tsx:6`
- App 組裝（資料源切換 + SigmaCanvas）：`src/App.tsx:127`

### 1.2 主要元件/模組
- 圖主畫布：`src/components/Graph/SigmaCanvas.tsx:226`
- 排版（ELK）：`src/components/Graph/ElkLayout.tsx:15`
- 搜尋：`src/components/Operations/GraphSearch.tsx:8`
- 資料源切換：`src/components/Operations/DataSourceToggle.tsx:9`
- 右鍵選單：`src/components/Graph/ContextMenu.tsx:13`
- 右側詳情面板：`src/components/Graph/NodeDetailPanel.tsx:71`
- 假資料生成器：`src/services/MockDataGenerator.ts:46`
- Worker（mock 生成 + json 載入）：`src/workers/graphData.worker.ts:52`

### 1.3 目前看起來「未接到主流程」的模組
- ForceAtlas2 layout 元件（未在 `SigmaCanvas` 使用）：`src/components/Graph/ForceAtlas2Layout.tsx:10`
- `useLayout.ts:1`：非 `src/`、且引用 `@xyflow/react` / `../types`，目前不像是此專案主流程的一部分（可視為遺留或另一段實驗）。

---

## 2) 資料來源與載入流程（App ↔ Worker）

### 2.1 App 端流程
- mock 參數設定：`src/App.tsx:9`
- 估算 mock 節點數（用來切換/防呆）：`src/App.tsx:22`
- 大圖門檻：`src/App.tsx:33`
- 建立 Worker：`src/App.tsx:65`
- 發送請求：
  - `json`：`src/App.tsx:53`
  - `mock`：`src/App.tsx:57`
- 接收回應（成功/失敗）：`src/App.tsx:68`

### 2.2 UI 切換資料來源（左上角按鈕）
- 元件：`src/components/Operations/DataSourceToggle.tsx:9`
- 選項：
  - `mock`：「假資料」：`src/components/Operations/DataSourceToggle.tsx:11`
  - `json`：「fakedata.json」：`src/components/Operations/DataSourceToggle.tsx:12`
- 切換時的防呆：
  - 如果估算 mock 節點數過大，會顯示錯誤並自動切 json：`src/App.tsx:107`

### 2.2 Worker 行為
- `generate`：呼叫 `MockDataGenerator.generateGraphData()`：`src/workers/graphData.worker.ts:59`
- `loadJson`：fetch + parse：`src/workers/graphData.worker.ts:66`
- `stripXY`：刻意移除 `x/y`，讓前端統一用 `useDiagram` 補座標：`src/workers/graphData.worker.ts:32`

---

## 3) 型別與資料模型（Graph Schema）

### 3.1 Graph 輸出結構
- `IGraphData`：`nodes` + `edges`：`src/interfaces/mock/IMockData.ts:118`

### 3.2 節點（Node）
- `ISigmaNode`：`id/label/x?/y?/size?/color?/data?`：`src/interfaces/mock/IMockData.ts:4`
- `NodePayload` 分型：
  - 理專：`src/interfaces/mock/IMockData.ts:28`
  - 客戶：`src/interfaces/mock/IMockData.ts:44`
  - 投資組合：`src/interfaces/mock/IMockData.ts:61`
  - 帳號：`src/interfaces/mock/IMockData.ts:75`

### 3.3 邊（Edge）
- `ISigmaEdge`：`id/source/target/label?/type?/data?`：`src/interfaces/mock/IMockData.ts:14`
- `EdgePayload`：
  - structural：`src/interfaces/mock/IMockData.ts:94`
  - transactional：`src/interfaces/mock/IMockData.ts:101`

---

## 4) useDiagram：座標補齊策略
- 目的：若來源資料未提供座標，補上 seeded ring position，避免 sigma 無法渲染：`src/hooks/useDiagram.ts:4`

---

## 5) SigmaCanvas：渲染設定與顯示規則

### 5.1 SigmaContainer 內部 graph 必須是 multi（平行邊）
- 自訂 multi directed graph constructor：`src/components/Graph/SigmaCanvas.tsx:51`
- 傳給 `SigmaContainer graph={...}`：`src/components/Graph/SigmaCanvas.tsx:458`
- 背景原因：@react-sigma/core 內部會建立自己的 graph；若不是 multi，`graph.import(...)` 遇到同一組 A→B 多條邊會丟 `edge already exists`。

### 5.2 settings（sigma renderer 設定）
- 設定入口：`const settings = useMemo(() => ({ ... }))`：`src/components/Graph/SigmaCanvas.tsx:409`
- 主要設定（目前值）：
  - `renderEdgeLabels: true`：`src/components/Graph/SigmaCanvas.tsx:410`
  - `enableEdgeEvents: true`：`src/components/Graph/SigmaCanvas.tsx:411`
  - `minCameraRatio / maxCameraRatio`：`src/components/Graph/SigmaCanvas.tsx:412`
  - `labelDensity: 0.07`、`labelRenderedSizeThreshold: 0`：`src/components/Graph/SigmaCanvas.tsx:414`
  - `labelColor/edgeLabelColor` 設黑色：`src/components/Graph/SigmaCanvas.tsx:416`
  - `defaultDrawEdgeLabel: drawStraightEdgeLabel`：`src/components/Graph/SigmaCanvas.tsx:418`
  - `labelRenderer: drawLabel`：`src/components/Graph/SigmaCanvas.tsx:420`
  - `nodeProgramClasses: { image: createNodeImageProgram() }`：`src/components/Graph/SigmaCanvas.tsx:421`
  - `defaultEdgeType: "arrow"`：`src/components/Graph/SigmaCanvas.tsx:422`

### 5.2 初始可見性（只顯示理專）
- buildGraph 對非理專預設 `hidden: true`：`src/components/Graph/SigmaCanvas.tsx:700`

### 5.2.1 節點 icon（理專/客戶/帳號）
- icon 對應表：`/image/gangs.png`、`/image/person.png`、`/image/accounts.png`：`src/components/Graph/SigmaCanvas.tsx:28`
- 指定 `type: "image"` + `image` 欄位：`src/components/Graph/SigmaCanvas.tsx:724`
- 初始載入可能先顯示純色圓點，icon 載入完成後會切換（屬正常行為）。

### 5.3 reducers（顯示/隱藏/label）
- `nodeReducer`：hidden 節點 size=0、label=""：`src/components/Graph/SigmaCanvas.tsx:423`
- `edgeReducer`：
  - 任一端點 hidden → edge hidden：`src/components/Graph/SigmaCanvas.tsx:427`
  - edge label 顯示規則：`src/components/Graph/SigmaCanvas.tsx:444`
  - `平行交易` demo edge label 永遠顯示（不吃 zoom/hover）：`src/components/Graph/SigmaCanvas.tsx:447`
- Hover 聚焦淡化（2-hop，包含 structural+transactional）：
  - hover focus state：`hoverFocusRef`：`src/components/Graph/SigmaCanvas.tsx:231`
  - 2-hop 關聯集合計算（BFS）：`computeRelatedNodes(..., 2)`：`src/components/Graph/SigmaCanvas.tsx:256`
  - node 淡化：不在 relatedNodes → `color="#cbd5e1"`、`label=""`、移除 icon：`src/components/Graph/SigmaCanvas.tsx:423`
  - edge 淡化：任一端不在 relatedNodes → 改色/變細/清空 label：`src/components/Graph/SigmaCanvas.tsx:454`
  - debounce / 延遲清除：
    - `HOVER_FOCUS_APPLY_DELAY_MS`、`HOVER_FOCUS_CLEAR_DELAY_MS`：`src/components/Graph/SigmaCanvas.tsx:41`
    - timers：`hoverFocusTimersRef`：`src/components/Graph/SigmaCanvas.tsx:232`

### 5.3.1 備註節點（Note Node）
- 生成規則：若該節點有備註，會生成一個 note node 並以 `note-edge` 連接：`src/components/Graph/SigmaCanvas.tsx`
- note node attributes：`isNote=true`、`noteParentId`、`noteMaxWidth`、`label=備註文字`
- note node 位置：預設以父節點座標計算（未拖曳前）
- 備註節點可拖曳：拖曳後座標會記錄到 `notePositionsById`，匯出/匯入後保留位置

### 5.4 label renderer（自訂繪製）
- `drawLabel`：把節點文字畫在節點下方：`src/utils/sigma/drawLabel.ts:4`
- settings 指定 `labelRenderer`：`src/components/Graph/SigmaCanvas.tsx:419`
- GraphEvents 額外強制灌設定到 sigma instance：`src/components/Graph/SigmaCanvas.tsx:580`

### 5.5 初始載入淡入（避免閃爍）
- `SigmaContainer` 在 layout 完成前：`opacity: 0` + `pointerEvents: none`：`src/components/Graph/SigmaCanvas.tsx:463`
- layout 完成後：`handleLayoutStop` 會把 `isInitialLayoutReady` 設 true：`src/components/Graph/SigmaCanvas.tsx:239`

---

## 6) 平行邊（A→B 多條 edge）與曲線顯示

### 6.1 曲線 renderer
- 使用 `@sigma/edge-curve`：`src/components/Graph/SigmaCanvas.tsx:17`
- sigma settings 註冊：`edgeProgramClasses: { curved: EdgeCurveProgram }`：`src/components/Graph/SigmaCanvas.tsx:421`

### 6.2 curvature 計算與套用
- 依 `source→target` 分桶：`src/components/Graph/SigmaCanvas.tsx:726`
- 計算每條 edge 的 `curvature`（step=0.25，上限±0.9）：`src/components/Graph/SigmaCanvas.tsx:739`
- 平行邊設 `type:"curved"` + `curvature`：`src/components/Graph/SigmaCanvas.tsx:755`

---

## 7) 互動功能（事件與 UI）

### 7.0 GraphEvents 註冊與載入 graph
- `useLoadGraph()` 會把 `buildGraph` 建好的 graph 匯入 sigma：`src/components/Graph/SigmaCanvas.tsx:574`
- `useRegisterEvents()` 註冊 sigma 事件：`src/components/Graph/SigmaCanvas.tsx:654`
  - 部分互動事件改用 `sigma.getGraph()` 取資料，避免匯入後外部/內部 graph 不一致造成錯誤

### 7.8 匯出 / 匯入流程與解析欄位

**匯出流程**
1) 由 `exportGraph(graph)` 將目前外部 graph 輸出成 `nodes/edges`。
2) `uiState` 會一併輸出：
   - `markedNodeIds`（標記節點）
   - `notesByNodeId`（備註文字）
   - `notePositions`（備註節點拖曳座標）
   - `expandMode` / `layoutMode` / `camera`

**匯入流程**
1) `graph.clear()` 後 `graph.import(payload.graph)` 還原外部 graph。
2) 同步 sigma 內部 graph（避免對不齊）。
3) 解析 `uiState`：
   - `markedNodeIds` → `Set`
   - `notesByNodeId` → `Map`
   - `notePositions` → `Map`
   - `expandMode` / `layoutMode` / `camera` 套回狀態

**新增資料要能匯出**
- 若你新增「節點/邊屬性」：放在 graph node/edge attributes 中，`exportGraph` 會自動包含。
- 若你新增「UI 狀態」：需新增到 `uiState`（匯出與匯入都要補）。

### 7.1 搜尋（GraphSearch）
- 節點比對：`attributes.label.includes(search)`：`src/components/Operations/GraphSearch.tsx:27`
- 自動展開祖先（沿 incoming structural）：`src/components/Operations/GraphSearch.tsx:55`
- 相機定位（ratio=0.1 / duration=600）：`src/components/Operations/GraphSearch.tsx:71`
- 多結果導覽：`next/prev/Enter`：`src/components/Operations/GraphSearch.tsx:80`

### 7.2 右鍵選單
- UI：展開 / 資料詳情 / 隱藏：`src/components/Graph/ContextMenu.tsx:13`
- 觸發：rightClickNode 設定 contextMenu state：`src/components/Graph/SigmaCanvas.tsx:280`
- 防止瀏覽器原生右鍵選單：
  - rightClickNode 時 `preventDefault()`：`src/components/Graph/SigmaCanvas.tsx:282`
  - 也在 container 上阻止 `contextmenu`：`src/components/Graph/SigmaCanvas.tsx:623`

### 7.3 展開/隱藏（結構邊）
- 隱藏：把 outgoing structural children 設 hidden=true：`src/components/Graph/SigmaCanvas.tsx:296`
- 展開：把 outgoing structural children 設 hidden=false 並做局部重排：`src/components/Graph/SigmaCanvas.tsx:307`
- 右上角 Expand 模式切換：
  - `Structure`：`src/components/Graph/SigmaCanvas.tsx:503`
  - `Circle`：`src/components/Graph/SigmaCanvas.tsx:517`
  - `匯出圖片`：`src/components/Graph/SigmaCanvas.tsx:531`
- 展開後的局部重排策略（避免子節點貼太近/重疊）：
  - `minSeparation` + `shouldReposition`：`src/components/Graph/SigmaCanvas.tsx:325`
  - layered（Structure）扇出：`minDx`、`yStep`：`src/components/Graph/SigmaCanvas.tsx:381`
  - circle（Circle）均分散開：`baseRadius`、`densityBoost`：`src/components/Graph/SigmaCanvas.tsx:341`

### 7.4 拖曳節點與 pinned
- downNode：disable camera + 標 highlight：`src/components/Graph/SigmaCanvas.tsx:655`
- mousemove：把滑鼠座標轉 graph 座標更新 x/y：`src/components/Graph/SigmaCanvas.tsx:603`
- 放開後若移動：標記 `pinned=true`：`src/components/Graph/SigmaCanvas.tsx:615`
- pinned 行為：後續展開/重排會盡量跳過 pinned 節點：`src/components/Graph/SigmaCanvas.tsx:167`

### 7.5 Hover
- 節點 hover tooltip：`src/components/Graph/SigmaCanvas.tsx:545`
- edge hover：用 `hoveredEdgeIdRef` 控制 edge label 顯示：`src/components/Graph/SigmaCanvas.tsx:263`

### 7.6 右側詳情面板
- 依 businessType 組欄位：`src/components/Graph/NodeDetailPanel.tsx:19`
- UI 面板與關閉按鈕：`src/components/Graph/NodeDetailPanel.tsx:75`

### 7.7 右下角控制列
- Zoom / Fullscreen：`src/components/Graph/SigmaCanvas.tsx:533`

---

## 8) 排版策略（ELK 多中心群 + packing）

### 8.1 何時跑 layout
- `SigmaCanvas` 內永遠掛 `ElkLayout isLayoutActive={true}`：`src/components/Graph/SigmaCanvas.tsx:494`
- 初始載入淡入：等第一次 layout 完成才顯示畫布（opacity/pointerEvents）：`src/components/Graph/SigmaCanvas.tsx:463`

### 8.2 群定義：理專為群中心
- 找出所有理專作 roots：`src/components/Graph/ElkLayout.tsx:94`
- 依 inbound structural parent 往上推斷所屬理專（最多 10 層）：`src/components/Graph/ElkLayout.tsx:195`
- 若不同理專群有連線會 Union-Find 合併：`src/components/Graph/ElkLayout.tsx:107`
- 合併群後的代表理專（中心）選擇：用「插入順序最前」當代表：`src/components/Graph/ElkLayout.tsx:143`

### 8.3 群內排版（ELK）
- 依 layoutType 選 algorithm（layered/radial/mrtree）：`src/components/Graph/ElkLayout.tsx:303`
- node sizing（label-first sizing）：`src/components/Graph/ElkLayout.tsx:321`

### 8.4 重要：ELK 只吃 structural edges
- transactional edges 不納入 ELK，避免交易噪音干擾群內排版：`src/components/Graph/ElkLayout.tsx:331`

### 8.5 群間 packing
- 把每群 bbox 換算 radius 後 pack：`src/components/Graph/ElkLayout.tsx:260`
- packing 方法：golden-angle spiral 試點，直到不重疊：`src/components/Graph/ElkLayout.tsx:283`

---

## 9) 假資料內容（MockDataGenerator）重點

### 9.1 階層資料（structural）
- 理專→客戶→投資組合→帳號：`src/services/MockDataGenerator.ts:125`
- 固定樣本：第一個理專一定有「王大明」+「核心資產」+「銀行A 帳號」：`src/services/MockDataGenerator.ts:77`

### 9.2 交易資料（transactional）
- 銀行A 帳號固定交易（含外部帳戶節點）：`src/services/MockDataGenerator.ts:142`
- 隨機噪音交易：`src/services/MockDataGenerator.ts:175`
- 外部帳戶節點特徵：
  - node label：`外部帳戶`
  - `businessType: "帳號"`、`bankName: "他行"`、`ownerId: "UNKNOWN"`：`src/services/MockDataGenerator.ts:161`

### 9.3 保證平行交易 demo
- 每次至少 1 組、可選 2 組「同向三條平行交易邊」：`src/services/MockDataGenerator.ts:186`
- 優先用「理專→理專」當作平行邊 pair（確保一開畫面就可見）：`src/services/MockDataGenerator.ts:324`

---

## 10) 視覺與樣式（CSS）
- 全頁背景、控制元件外觀、水印、tooltip：`src/App.css:1`
- 全域字體與 body 背景：`src/index.css:1`

---

## 11) 其他備註（行為層）
- `SigmaCanvas` 會根據 `nodes.length > 2000` 進入 big data mode（節點更小）：`src/components/Graph/SigmaCanvas.tsx:227`
- `GraphSearch` 的下拉建議只顯示前 10 筆（避免清單過長）：`src/components/Operations/GraphSearch.tsx:144`
