# 相關設定（參數位置總表）

> 目的：把目前專案中「調整參數 → 影響效果 → 對應檔案/位置」集中在這份文件，方便後續一起討論與微調。
>
> 說明：以下以 **目前專案實作** 為準（含右鍵選單、展開/隱藏、ELK 排版、edge/label 顯示、搜尋定位、拖曳節點等）。

---

## 1) 主入口（大多數設定都在這）

檔案：`src/components/Graph/SigmaCanvas.tsx`

### 1.1 Sigma Renderer 設定（settings）

位置：`const settings = useMemo(() => ({ ... }))`

- **鏡頭縮放上下限**
  - `minCameraRatio` / `maxCameraRatio`
  - 影響：使用者可縮放的最小/最大倍數（`ratio` 越小越 zoom-in）
- **節點 label 是否渲染**
  - `labelRenderedSizeThreshold: 0`
  - 影響：目前等於「不設門檻」，只要節點未 hidden，label 都可渲染（但仍受 reducer 影響）
- **文字顏色（黑色）**
  - `labelColor: { color: "#000000" }`
  - `edgeLabelColor: { color: "#000000" }`
  - 影響：節點/邊 label 的預設字色
- **邊 label 是否渲染**
  - `renderEdgeLabels: true`
  - `defaultDrawEdgeLabel: drawStraightEdgeLabel`
  - 影響：啟用並使用 sigma 內建的直線邊 label 繪製器
- **啟用 edge hover 事件**
  - `enableEdgeEvents: true`
  - 影響：沒有開的話 `enterEdge/leaveEdge` 不會觸發（hover edge 看不到文字也常跟這個有關）

### 1.2 Node / Edge Reducer（顯示邏輯：隱藏、label 顯示等）

位置：同上 `settings`

- **節點隱藏**
  - `nodeReducer`: 若 `data.hidden` → 回傳 `size: 0` + `label: ""`
  - 影響：hidden 節點不畫、不顯示 label（用來配合右鍵「展開/隱藏」與搜尋自動展開）
- **邊隱藏**
  - `edgeReducer`: 若 source/target 任一節點 hidden → edge 回傳 `hidden: true`
  - 影響：hidden 節點相關邊不顯示（避免畫面上有「飄著的邊」）

### 1.3 Edge 文字顯示規則（hover / zoom-in 才顯示）

位置：`EDGE_LABEL_SHOW_MAX_CAMERA_RATIO`

- `EDGE_LABEL_SHOW_MAX_CAMERA_RATIO`
  - 影響：未 hover 時，鏡頭 zoom-in 到 `ratio <= 這個值` 才顯示 edge label
  - 調整方向：
    - 想「更晚才出現」→ 調小
    - 想「更早就出現」→ 調大
- hover 顯示
  - `hoveredEdgeIdRef.current === edge` 時強制顯示該 edge label

### 1.4 初始載入不閃爍（等 ELK 完成後再顯示）

位置：`isInitialLayoutReady` 與 `SigmaContainer style.opacity`

- 目前行為：第一次 ELK layout 完成前，主畫布 `opacity: 0` + `pointerEvents: none`，完成後淡入
- 影響：避免先看到 `buildGraph` 的隨機座標再跳到 ELK 的「閃一下」
- 若你想直接看到過渡：可把 `opacity` 固定 1（但會回到閃爍）

---

## 2) 節點文字（位置/樣式）

檔案：`src/utils/sigma/drawLabel.ts`

- **文字位置：目前畫在節點下方**
  - `const y = data.y + data.size + 3`
  - 調整方向：
    - 想更靠近節點：把 `+ 3` 調小或改成 `+ 0`
    - 想往上/往下：調整這個 y 偏移
- **字體/大小/粗細**
  - 來源：sigma settings 的 `labelFont` / `labelSize` / `labelWeight`
  - 目前 `drawLabel` 直接使用 settings 值：`context.font = \`\${weight} \${size}px \${font}\``
- **字色**
  - 來源：sigma settings 的 `labelColor`（已設黑色）

---

## 3) ELK 排版（Structure：多中心群 + circle packing）

檔案：`src/components/Graph/ElkLayout.tsx`

### 3.1 ELK 演算法切換（layered / radial / mrtree）

- 入口：`toElkAlgorithm(layoutType)`
  - `layoutType` 由 `SigmaCanvas` 傳入（目前固定 layered，但型別保留 radial）
- 參數：`buildElkLayoutOptions(algorithm)`
  - layered：`elk.direction: RIGHT`、node/edge spacing 等
  - radial/mrtree：使用對應 algorithm + spacing（目前是 baseline 設定）

### 3.2 多中心群（理專為群中心）

- 群切分：`buildAdvisorGroups(graph)`
  - 依節點 payload 的 `metaData.businessType === "理專"` 找出理專
  - 其他節點會沿 incoming structural 往上找「所屬理專」
- 跨群合併（有跨理專連線就視為同一群）
  - 使用 Union-Find（DisjointSet）把有連線的理專群合併
  - 合併後中心理專：取「理專插入順序最前」做代表中心

### 3.3 群內排版（每群各跑一次 ELK）

- `runElkForGroup`：把該群 nodes/edges 轉成 ELK payload → `elk.layout(...)`
- 「Label-first sizing」策略（影響重疊/間距）
  - `width = size * 2 + 150`
  - `height = size * 2 + 20`
  - 調整方向：
    - label 常重疊 → 增加 `+150` / `+20`
    - 圖太鬆散 → 減少 `+150` / `+20` 或降低 spacing

### 3.4 群間排版（circle packing）

- `layoutAndPackGroups` 會先算每群 bbox，再把 bbox 對角線換算成 `radius`，最後用 `packCircles(...)` 放置
- 可調參數：
  - `groupGap`（每群外圈間距）：越大越不會撞群、但畫面更分散
  - `packCircles` 的 step / 迭代上限（若群很多、需要更密集或更快）

---

## 4) Edge 樣式與文字

檔案：`src/components/Graph/SigmaCanvas.tsx`

### 4.1 Edge 顏色/粗細/權重

位置：`buildGraph(...)` 裡的 `graph.addEdgeWithKey(..., { ... })`

- `color`
  - structural：`#e2e8f0`
  - transactional：`#64748b`
- `size`
  - transactional：3
  - structural：1
- `type: "arrow"`
  - 影響：邊使用箭頭樣式（sigma 預設 edge type）
- `weight` / `zIndex`
  - 用來影響佈局/顯示順序（目前 transactional 權重更高、zIndex 更上層）

### 4.2 Edge label（文字）來源

- `label: edge.label ?? fallbackLabel`
  - 若原始資料沒有 label，會用 fallback：transactional=`交易`、structural=`結構`
- 顯示條件：見上方「1.3 Edge 文字顯示規則」

---

## 5) 右鍵選單（Context Menu）

檔案：`src/components/Graph/ContextMenu.tsx`

選單項目與 callback：
- `展開 (Expand)` → `onExpand(nodeId)`
- `資料詳情` → `onShowDetails(nodeId)`（開右側面板）
- `隱藏 (Hide)` → `onHide(nodeId)`

觸發位置：
- 右鍵點 node 事件：`src/components/Graph/SigmaCanvas.tsx` 內 `handleRightClickNode`

---

## 6) 右側面板（資料詳情 / Side Panel）

檔案：`src/components/Graph/NodeDetailPanel.tsx`

- 內容來源：`SigmaCanvas` 會把 graph node attribute `payload` 傳進去（`payload.data`）
- 欄位會依 `businessType` 切換（理專/客戶/投資組合/帳號）
- 樣式：
  - 右側半透明：`background: rgba(255,255,255,0.82)` + `backdropFilter: blur(8px)`
  - 關閉：右上角 `X`

若你要接真實 API：
- 保留面板 UI，只要把 `payload` 來源改成 API 回傳即可（例如用 nodeId 打 API）

---

## 7) 搜尋（Search Bar）

檔案：`src/components/Operations/GraphSearch.tsx`

行為摘要：
- 搜尋範圍：遍歷 graph 的 `attributes.label`，做 `includes` 比對
- 命中後定位：
  1) 先沿 incoming structural 邊往上把祖先全部 `hidden=false`（確保路徑可見）
  2) `sigma.refresh()` 立即套用
  3) `camera.animate({ ...nodePosition, ratio: 0.1 }, { duration: 600 })`

可調參數：
- 定位縮放：`ratio: 0.1`（越小越近）
- 動畫時間：`duration: 600`

---

## 8) 節點拖曳 / 鏡頭移動（互動）

檔案：`src/components/Graph/SigmaCanvas.tsx`（GraphEvents）

### 8.1 拖曳節點

- 事件：`downNode` 開始拖曳 → `mousemove` 更新座標 → `mouseup/mouseleave` 結束
- 轉換：使用 `sigma.viewportToGraph({ x, y })` 把滑鼠座標轉成 graph 座標
- 拖曳期間：
  - `sigma.getCamera().disable()`（避免拖曳節點時鏡頭一起被拖）
  - 結束時 `sigma.getCamera().enable()`

### 8.2 鏡頭平移/縮放

- Sigma 預設支援滑鼠拖曳平移、滾輪縮放（由 sigma settings 控制）
- UI 控制：
  - 右下角 `ZoomControl` / `FullScreenControl`（由 `@react-sigma/core` 提供）

---

## 9) 假資料來源（節點/邊類型）

檔案：
- 生成：`src/services/MockDataGenerator.ts`
- 型別：`src/interfaces/mock/IMockData.ts`

重點：
- businessType（理專/客戶/投資組合/帳號）會影響：
  - 節點顏色/大小（`SigmaCanvas buildGraph`）
  - 右側資料詳情欄位（`NodeDetailPanel`）
  - ELK 分群中心（理專為群中心，`ElkLayout`）

