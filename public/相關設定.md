# 相關設定（參數位置總表）

> 目的：把目前專案中「調整參數 → 影響效果 → 對應檔案/位置」集中在這份文件，方便後續一起討論與微調。
>
> 說明：以下以 **目前專案實作** 為準（含右鍵選單、展開/隱藏、ELK 排版、edge/label 顯示、搜尋定位、拖曳節點等）。

---

## 1) 主入口（大多數設定都在這）

檔案：`src/components/Graph/SigmaCanvas.tsx`

### 1.0 展開模式（Structure / Circle）

位置：`expandMode` 與右上角按鈕（Structure / Circle / 匯出圖片）

- `Structure`
  - 影響：展開後的子節點會用「結構式扇出」的局部規則（以 layered 的右向結構為主），避免父子重疊
- `Circle`
  - 影響：展開時只對「本次新顯示」的 structural 子節點做圓形均分：
    - 角度：`angle = 2π * i / N`（均分）
    - 半徑：動態（基於父節點 size、子節點數量、平均子 size）
    - 參數位置：`src/components/Graph/SigmaCanvas.tsx` 的 `baseRadius` / `densityBoost`（越大圈越大）
  - 用途：更像關係探索/局部爆開，快速看某節點四周關聯

### 1.0.1 模式切換重排策略（A / B）

位置：`relayoutVisibleStructuralNodes(...)`（`src/components/Graph/SigmaCanvas.tsx`）

- **策略 A（目前採用）**
  - 切換 Structure / Circle 時，重排「所有可見且非根節點」
  - 根節點定義：沒有 structural parent 的節點
  - 影響：搜尋自動展開或匯入後可見的節點也會被重排；成本較高
- **策略 B（備選）**
  - 僅重排「已展開路徑」上的可見子節點
  - 影響：更保守、效能較好，但切換模式時更新範圍較小
  - 備註：切換模式不會啟用 ELK，全圖不重排

### 1.1 Sigma Renderer 設定（settings）

位置：`const settings = useMemo(() => ({ ... }))`

- **曲線邊（平行邊避免重疊）**
  - `edgeProgramClasses: { curved: EdgeCurveProgram }`（`@sigma/edge-curve`）
  - `defaultEdgeType: "arrow"`
  - 影響：當同一組 `A -> B` 有多條 edge 時，可用 `type: "curved"` + `curvature` 讓邊以不同曲率分開顯示
- **Multi Graph（允許同一組 A->B 多條 edge）**
  - `SigmaContainer graph={MultiDirectedGraph}`（`MultiDirectedGraph` 內部 `new Graph({ type: "directed", multi: true })`）
  - 影響：@react-sigma/core 內部會建立自己的 graph；若不是 multi，匯入平行邊會直接丟錯（`edge already exists`）
- **鏡頭縮放上下限**
  - `minCameraRatio` / `maxCameraRatio`
  - 影響：使用者可縮放的最小/最大倍數（`ratio` 越小越 zoom-in）
- **節點 label 是否渲染**
  - `labelRenderedSizeThreshold: 0`
  - 影響：目前等於「不設門檻」，只要節點未 hidden，label 都可渲染（但仍受 reducer 影響）
- **文字顏色（黑色）**
  - `labelColor: { color: "#000000" }`
  - `edgeLabelColor: { color: "#000000" }`
  - 影響：節點/邊 label 的預設字色
- **邊 label 是否渲染**
  - `renderEdgeLabels: true`
  - `defaultDrawEdgeLabel: drawStraightEdgeLabel`
  - 影響：啟用並使用 sigma 內建的直線邊 label 繪製器
- **啟用 edge hover 事件**
  - `enableEdgeEvents: true`
  - 影響：沒有開的話 `enterEdge/leaveEdge` 不會觸發（hover edge 看不到文字也常跟這個有關）
- **節點 icon（image program）**
  - `nodeProgramClasses: { image: createNodeImageProgram() }`（`@sigma/node-image`）
  - 影響：可讓節點使用 `type: "image"` 與 `image` 欄位渲染 icon

### 1.2 Node / Edge Reducer（顯示邏輯：隱藏、label 顯示等）

位置：同上 `settings`

- **節點隱藏**
  - `nodeReducer`: 若 `data.hidden` → 回傳 `size: 0` + `label: ""`
  - 影響：hidden 節點不畫、不顯示 label（用來配合右鍵「展開/隱藏」與搜尋自動展開）
- **邊隱藏**
  - `edgeReducer`: 若 source/target 任一節點 hidden → edge 回傳 `hidden: true`
  - 影響：hidden 節點相關邊不顯示（避免畫面上有「飄著的邊」）
- **Hover 聚焦（2-hop 關聯範圍，其餘淡化）**
  - 行為：hover 某節點時，會把該節點 **2-hop** 內的關聯節點/邊保留原樣，其餘節點/邊淡化成灰色
  - 關聯計算：同時包含 `structural` 與 `transactional` 邊（把整張圖視為「連得到就算關聯」）
  - 淡化策略：
    - node：改色、並清空 label；同時移除 icon（回到灰色圓點）
    - edge：改色、稍微變細、並清空 label
  - 防閃爍：有做 debounce / 延遲清除（避免滑過密集節點時狂閃）

### 1.2.1 節點 icon（理專 / 客戶 / 帳號）

位置：`buildGraph(...)` 的 `graph.mergeNode(...)`

- icon 對應：
  - 理專：`/image/gangs.png`
  - 客戶：`/image/person.png`
  - 帳號：`/image/accounts.png`
- 節點 attrs：`type: "image"` + `image: "<url>"`
- 初始載入可能先顯示純色節點，icon 載入完成後會自動切換（正常行為）

### 1.2.2 標記節點（Marked）

位置：`src/components/Graph/SigmaCanvas.tsx`

- 狀態來源：`markedNodeIds`（由右鍵選單切換 `toggleMarkedNode`）
- 樣式設定：`MARKED_COLOR` / `MARKED_BORDER_COLOR` / `MARKED_BORDER_SIZE`
- 呈現行為：標記節點會改為 `circle` 並提高 `zIndex`，且在 hover 聚焦淡化時仍保留高亮
- 保存範圍：僅記憶體狀態，重新整理後會清空

### 1.2.3 備註節點（Note Node）

位置：`src/components/Graph/SigmaCanvas.tsx`

- 產生條件：節點有備註時，生成對應 note node + note edge
- note node 樣式：使用圓形與固定色 `NOTE_COLOR`
- note node 位置：預設以父節點座標計算（未拖曳前）
- note node 拖曳保存：
  - 拖曳後會記錄到 `notePositionsById`
  - 匯出/匯入 JSON 後仍保留拖曳座標

### 1.3 Edge 文字顯示規則（hover / zoom-in 才顯示）

位置：`EDGE_LABEL_SHOW_MAX_CAMERA_RATIO`

- `EDGE_LABEL_SHOW_MAX_CAMERA_RATIO`
  - 影響：未 hover 時，鏡頭 zoom-in 到 `ratio <= 這個值` 才顯示 edge label
  - 調整方向：
    - 想「更晚才出現」→ 調小
    - 想「更早就出現」→ 調大
- hover 顯示
  - `hoveredEdgeIdRef.current === edge` 時強制顯示該 edge label
- **平行交易 demo 例外（永遠顯示）**
  - label 以 `平行交易` 開頭的 edge，會忽略 zoom/hover 規則直接顯示
  - 用途：方便確認「同向三條平行交易邊」是否成功產生與分離

### 1.3.1 Hover 聚焦的 debounce 參數

位置：`src/components/Graph/SigmaCanvas.tsx`

- `HOVER_FOCUS_APPLY_DELAY_MS`
  - 影響：hover 停留超過此時間才套用「關聯聚焦」，減少掃過節點時閃爍
- `HOVER_FOCUS_CLEAR_DELAY_MS`
  - 影響：離開節點後延遲多久才清除「關聯聚焦」，避免滑鼠邊界抖動

### 1.4 初始載入不閃爍（等 ELK 完成後再顯示）

位置：`isInitialLayoutReady` 與 `SigmaContainer style.opacity`

- 目前行為：第一次 ELK layout 完成前，主畫布 `opacity: 0` + `pointerEvents: none`，完成後淡入
- 影響：避免先看到 `buildGraph` 的隨機座標再跳到 ELK 的「閃一下」
- 若你想直接看到過渡：可把 `opacity` 固定 1（但會回到閃爍）

### 1.5 大資料量載入（Web Worker：避免 UI 卡死）

位置：`src/App.tsx`、`src/workers/graphData.worker.ts`、`src/components/Operations/DataSourceToggle.tsx`

- 目的：把「mock 生成」與「`public/fakedata.json` 解析」移到 Web Worker 執行，避免主執行緒長時間計算導致瀏覽器「網站沒有回應」。
- 切換方式：UI 左上角 `DataSourceToggle`
  - `假資料`（mock）：由 Worker 呼叫 `MockDataGenerator` 產生資料
  - `fakedata.json`（json）：由 Worker `fetch("/fakedata.json")` 後 `JSON.parse`
- 安全護欄：若 mock 估算節點數過大，會提示並自動改用 `fakedata.json`（門檻在 `src/App.tsx` 的 `BIG_GRAPH_NODE_THRESHOLD`）。

---

## 2) 節點文字（位置/樣式）

檔案：`src/utils/sigma/drawLabel.ts`

- **文字位置：目前畫在節點下方**
  - `const y = data.y + data.size + 3`
  - 調整方向：
    - 想更靠近節點：把 `+ 3` 調小或改成 `+ 0`
    - 想往上/往下：調整這個 y 偏移
- **字體/大小/粗細**
  - 來源：sigma settings 的 `labelFont` / `labelSize` / `labelWeight`
  - 目前 `drawLabel` 直接使用 settings 值：`context.font = \`\${weight} \${size}px \${font}\``
- **字色**
  - 來源：sigma settings 的 `labelColor`（已設黑色）

---

## 3) ELK 排版（Structure：多中心群 + circle packing）

檔案：`src/components/Graph/ElkLayout.tsx`

補充（本專案做法）：
- **ELK 只吃 structural edges**
  - transactional edges 不納入 ELK layout，避免「交易噪音」影響群內分層與間距

### 3.1 ELK 演算法切換（layered / radial / mrtree）

- 入口：`toElkAlgorithm(layoutType)`
  - `layoutType` 由 `SigmaCanvas` 傳入（目前固定 layered，但型別保留 radial）
- 參數：`buildElkLayoutOptions(algorithm)`
  - layered：`elk.direction: RIGHT`、node/edge spacing 等
  - radial/mrtree：使用對應 algorithm + spacing（目前是 baseline 設定）

### 3.2 多中心群（理專為群中心）

- 群切分：`buildAdvisorGroups(graph)`
  - 依節點 payload 的 `metaData.businessType === "理專"` 找出理專
  - 其他節點會沿 incoming structural 往上找「所屬理專」
- 跨群合併（有跨理專連線就視為同一群）
  - 使用 Union-Find（DisjointSet）把有連線的理專群合併
  - 合併後中心理專：取「理專插入順序最前」做代表中心

### 3.3 群內排版（每群各跑一次 ELK）

- `runElkForGroup`：把該群 nodes/edges 轉成 ELK payload → `elk.layout(...)`
- 「Label-first sizing」策略（影響重疊/間距）
  - `width = size * 2 + 150`
  - `height = size * 2 + 20`
  - 調整方向： 
    - label 常重疊 → 增加 `+150` / `+20`
    - 圖太鬆散 → 減少 `+150` / `+20` 或降低 spacing

### 3.4 群間排版（circle packing）

- `layoutAndPackGroups` 會先算每群 bbox，再把 bbox 對角線換算成 `radius`，最後用 `packCircles(...)` 放置
- 可調參數：
  - `groupGap`（每群外圈間距）：越大越不會撞群、但畫面更分散
  - `packCircles` 的 step / 迭代上限（若群很多、需要更密集或更快）

---

## 4) Edge 樣式與文字

檔案：`src/components/Graph/SigmaCanvas.tsx`

### 4.1 Edge 顏色/粗細/權重

位置：`buildGraph(...)` 裡的 `graph.addEdgeWithKey(..., { ... })`

- `color`
  - structural：`#e2e8f0`
  - transactional：`#64748b`
- `size`
  - transactional：3
  - structural：1
- `type: "arrow"`
  - 影響：一般邊使用箭頭樣式（sigma 預設 edge type）
- `type: "curved"` + `curvature: number`
  - 影響：同向平行邊（同一組 `source -> target` 多條 edge）會改用曲線邊並套不同曲率，讓多條邊不重疊
- `weight` / `zIndex`
  - 用來影響佈局/顯示順序（目前 transactional 權重更高、zIndex 更上層）

### 4.2 Edge label（文字）來源

- `label: edge.label ?? fallbackLabel`
  - 若原始資料沒有 label，會用 fallback：transactional=`交易`、structural=`結構`
- 顯示條件：見上方「1.3 Edge 文字顯示規則」

---

## 5) 右鍵選單（Context Menu）

檔案：`src/components/Graph/ContextMenu.tsx`

選單項目與 callback：
- `展開 (Expand)` → `onExpand(nodeId)`
- `資料詳情` → `onShowDetails(nodeId)`（開右側面板）
- `標記 / 取消標記` → `onToggleMark(nodeId)`（切換標記狀態）
- `隱藏 (Hide)` → `onHide(nodeId)`

觸發位置：
- 右鍵點 node 事件：`src/components/Graph/SigmaCanvas.tsx` 內 `handleRightClickNode`

---

## 6) 右側面板（資料詳情 / Side Panel）

檔案：`src/components/Graph/NodeDetailPanel.tsx`

- 內容來源：`SigmaCanvas` 會把 graph node attribute `payload` 傳進去（`payload.data`）
- 欄位會依 `businessType` 切換（理專/客戶/投資組合/帳號）
- 備註來源：`SigmaCanvas` 內的 `notesByNodeId`，依節點 id 保存
- 保存範圍：僅記憶體狀態，切換節點不會清空，重新整理後會清空
- 樣式：
  - 右側半透明：`background: rgba(255,255,255,0.82)` + `backdropFilter: blur(8px)`
  - 關閉：右上角 `X`

若你要接真實 API：
- 保留面板 UI，只要把 `payload` 來源改成 API 回傳即可（例如用 nodeId 打 API）

---

## 7) 搜尋（Search Bar）

檔案：`src/components/Operations/GraphSearch.tsx`

行為摘要：
- 搜尋範圍：遍歷 graph 的 `attributes.label`，做 `includes` 比對
- 命中後定位：
  1) 先沿 incoming structural 邊往上把祖先全部 `hidden=false`（確保路徑可見）
  2) `sigma.refresh()` 立即套用
  3) `camera.animate({ ...nodePosition, ratio: 0.1 }, { duration: 600 })`

可調參數：
- 定位縮放：`ratio: 0.1`（越小越近）
- 動畫時間：`duration: 600`

---

## 8) 節點拖曳 / 鏡頭移動（互動）

檔案：`src/components/Graph/SigmaCanvas.tsx`（GraphEvents）

### 8.1 拖曳節點

- 事件：`downNode` 開始拖曳 → `mousemove` 更新座標 → `mouseup/mouseleave` 結束
- 轉換：使用 `sigma.viewportToGraph({ x, y })` 把滑鼠座標轉成 graph 座標
- 拖曳期間：
  - `sigma.getCamera().disable()`（避免拖曳節點時鏡頭一起被拖）
- 結束時 `sigma.getCamera().enable()`

### 8.3 JSON 匯出 / 匯入（UI State）

位置：`src/components/Graph/SigmaCanvas.tsx`

- 匯出內容：
  - `markedNodeIds`
  - `notesByNodeId`
  - `notePositions`（備註節點拖曳座標）
- 匯入行為：
  - 同步外部 graph 與 sigma 內部 graph，避免節點對不齊

### 8.2 鏡頭平移/縮放

- Sigma 預設支援滑鼠拖曳平移、滾輪縮放（由 sigma settings 控制）
- UI 控制：
  - 右下角 `ZoomControl` / `FullScreenControl`（由 `@react-sigma/core` 提供）

---

## 9) 假資料來源（節點/邊類型）

檔案：
- 生成：`src/services/MockDataGenerator.ts`
- 型別：`src/interfaces/mock/IMockData.ts`

重點：
- businessType（理專/客戶/投資組合/帳號）會影響：
  - 節點顏色/大小（`SigmaCanvas buildGraph`）
  - 右側資料詳情欄位（`NodeDetailPanel`）
  - ELK 分群中心（理專為群中心，`ElkLayout`）
- **保證平行交易 demo**
  - 每次 mock 生成時，會保證至少 1 組、最多 2 組「同向三條平行交易邊」（label：`平行交易A-1/2/3`、可選 `平行交易B-1/2/3`）
  - 為了「一開畫面就看得到」，這些平行交易邊會優先連到理專節點（理專預設 `hidden=false`）

---

## 10) 整頁背景圖（水印）

檔案：`src/App.css`

- `.app-container`
  - `background: #f8fafc`
  - 影響：移除原本深藍/放射漸層底色，改成淺色背景，讓圖區水印更清楚

- `.graph-container::before`
  - `background-image: url("/image/image.png")`
  - `width: min(70vw, 1100px)` / `height: min(70vh, 700px)`（只在畫面中央一塊區域放水印）
  - `background-size: min(40vw, 360px) auto`
  - `opacity: 0.08`
  - 影響：只在畫面中間區域疊一個淡淡的 logo 水印，不影響互動（`pointer-events: none`）

- `.graph-container canvas`
  - `background: transparent !important;`
  - 影響：Sigma canvas 預設白底會蓋掉背景圖，這條規則強制 canvas 透明讓水印可見

- `.app-container`
  - `--sigma-background-color: transparent;`
  - 影響：`@react-sigma/core` 預設會把 `div.react-sigma` 背景設成白色（CSS 變數 `--sigma-background-color`），這裡改成透明才不會蓋掉背景水印
