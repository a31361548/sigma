# 功能彙整（以 UI 可見為準）

> 本文件只整理「你在畫面上看得到、操作得到」的功能與行為，不包含程式檔案位置與內部實作細節。

---

## 1) 載入與資料來源

### 1.1 載入狀態
- 進入頁面後會先看到 `Loading...`。
- 若載入失敗，會顯示「載入失敗：<錯誤訊息>」的提示面板。

### 1.2 資料來源切換（左上角）
- `假資料`：使用程式即時產生的範例資料。
- `fakedata.json`：載入 `public/fakedata.json` 的資料。
- 切換資料來源後，會重新載入並刷新整張圖。

> 補充：若 mock 估算資料量過大，系統會阻止切換並提示，改用 `fakedata.json`（避免瀏覽器卡住）。

---

## 2) 圖形主畫布（Graph）

### 2.1 初始視圖（預設顯示哪些節點）
- 預設只顯示「理專」節點，其他類型節點會先隱藏，避免一開始資訊爆量。

### 2.2 背景水印
- 圖區中央會有淡淡的背景水印（不影響滑鼠互動）。

### 2.3 節點圖示（Icon）
- 理專 / 客戶 / 帳號節點會以對應 icon 顯示。
- 初始載入時可能先短暫顯示純色節點，圖示載入完成後會自動切換為 icon。

---

## 3) 搜尋（上方置中）

### 3.1 節點搜尋
- 可輸入關鍵字搜尋節點名稱（模糊包含比對）。
- 搜尋有結果時：
  - 會顯示 `目前第幾筆 / 總共幾筆`。
  - 可用按鈕「上一筆 / 下一筆」切換聚焦。
  - 也可按 `Enter` 直接跳到下一筆。

### 3.2 自動展開與定位
- 點選搜尋結果後會自動：
  - 把該節點「往上層的結構路徑」需要顯示的節點全部展開（確保看得到上下文）。
  - 鏡頭自動移動並放大定位到該節點。

---

## 4) 右鍵選單（對節點右鍵）

在任一節點上按右鍵會出現選單：
- `展開 (Expand)`：顯示該節點的「結構子節點」（往外延伸的下一層）。
- `資料詳情`：打開右側資料面板，顯示該節點的欄位內容。
- `標記 / 取消標記`：切換該節點的標記狀態，便於視覺高亮。
- `隱藏 (Hide)`：把該節點的「結構子節點」隱藏起來（並同步隱藏相關連線）。

> 補充：標記僅存在於本次頁面狀態，重新整理後會清空。

---

## 5) 右側資料面板（資料詳情）

### 5.1 觸發方式
- 右鍵節點 → `資料詳情`。

### 5.2 顯示內容
- 會依節點類型（理專 / 客戶 / 投資組合 / 帳號）顯示不同欄位。
- 面板右上角 `X` 可關閉。

### 5.3 備註
- 面板底部提供「備註」輸入框。
- 備註會依節點各自保存，切換節點後回來仍可看到先前輸入內容。
- 備註僅存在於本次頁面狀態，重新整理後會清空。
- 若該節點有備註，畫面會自動產生一個「備註節點」並連線到原節點。
- 備註節點可拖曳；拖曳後的位置會在匯出 / 匯入 JSON 後保留。

---

## 6) 展開模式切換（右上角）

右上角有兩個模式按鈕：
- `Structure`：展開後的子節點以「偏結構化扇出」方式排列，優先避免重疊。
- `Circle`：展開時把「本次新顯示」的子節點用圓形均分散開，適合快速看周邊關係。
- `匯出圖片`：下載目前畫布為 PNG（白底）。
- `匯出JSON`：下載目前圖資料與 UI 狀態（含標記與備註）。
- `匯入JSON`：載入先前匯出的 JSON，還原節點位置、標記與備註。

> 補充（目前策略 A）：切換 Structure / Circle 時，會重新排版**所有可見且非根節點**（根節點 = 沒有 structural parent 的節點），包含搜尋自動展開或匯入後可見的節點；根節點位置不動。  
> 備選策略 B：只重排「已展開路徑」上的可見子節點（較保守、效能較佳）。
> 另外：切換模式不會觸發 ELK 全圖重排，只會使用上述局部重排邏輯。

---

## 7) 拖曳節點（滑鼠左鍵）

- 可用滑鼠左鍵拖曳節點改位置。
- 拖曳後節點會被視為「固定」，後續自動排版/展開重排會盡量不再移動它（避免你手動調整被覆蓋）。

---

## 8) 空白處雙擊新增文字註記

- 在畫布空白處「雙擊」會出現一個文字輸入框（含「確認/取消」按鈕）。
- 按「確認」後會在點擊位置生成一個「透明節點」，其文字為輸入內容，並以紅色顯示。
- 文字會自動換行，且即使未 hover 也會常亮顯示。

---

## 8) Hover 顯示（滑過節點/邊）

### 8.1 節點 Hover Tooltip
- 滑過節點會出現一個小提示框（顯示節點名稱）。

### 8.2 Hover 聚焦（2-hop 關聯高亮，其餘淡化）
- 滑過任一節點時，系統會以該節點為中心，將 **2-hop 內**（兩層連線距離內）的「關聯節點與關聯邊」保留原樣。
- 其他「不相關」的節點與邊會被 **淡化成灰色**（不會消失），節點會回到灰色圓點（不顯示 icon）。
- 關聯計算包含：
  - `structural`（結構）邊
  - `transactional`（交易）邊

### 8.2 邊文字（Edge Label）顯示規則
- 一般情況下：
  - 滑過某條邊時，該邊的文字會顯示。
  - 沒有滑過時，需要把畫面放大到一定程度才會顯示邊文字（避免縮小時滿畫面都是字）。
- Demo 例外（平行交易）：
  - 名稱以「平行交易」開頭的邊，會固定顯示文字，方便確認平行邊效果。

---

## 9) 平行邊（A→B 多條邊）顯示效果

- 若存在同方向 `A → B` 多條邊，畫面會以「曲線」方式將多條邊分開，避免完全重疊看不出來。
- 在假資料模式下，系統會保證至少有一組「同方向三條平行交易邊」可用來驗證（名稱為 `平行交易A-1/2/3`，有時會再多一組 `平行交易B-1/2/3`）。

---

## 10) 右下角控制列

- `ZoomControl`：放大 / 縮小 / 重置視角（視使用的控制元件行為而定）。

---

## 11) 使用建議（最常見操作）

- 想從總覽開始探索：先看理專節點 → 右鍵 `展開` 往下層一層層展開。
- 想快速定位：用搜尋直接跳到目標節點，系統會自動展開祖先並置中。
- 想整理畫面：對節點右鍵 `隱藏`，把不需要的分支收起來。
